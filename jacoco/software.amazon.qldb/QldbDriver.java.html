<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QldbDriver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">software.amazon.qldb:amazon-qldb-driver-java</a> &gt; <a href="index.source.html" class="el_package">software.amazon.qldb</a> &gt; <span class="el_source">QldbDriver.java</span></div><h1>QldbDriver.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

package software.amazon.qldb;

import software.amazon.qldb.exceptions.TransactionAbortedException;

/**
 * &lt;p&gt;The driver for Amazon QLDB.&lt;/p&gt;
 *
 * &lt;p&gt;The main goal of the driver is to receive lambda functions that are passed to any of its execute methods.
 * The code in these lambda functions should be idempotent as the lambda function might be
 * called more than once based on the TransactionRetryPolicy.
 * &lt;/p&gt;
 *
 * &lt;h3&gt;Idempotency:&lt;/h3&gt;
 * &lt;p&gt;A transaction needs to be idempotent to avoid undesirable side effects.&lt;/p&gt;
 *
 * &lt;p&gt;For example, consider the below transaction which inserts a document into People table. It first checks if the document
 * already exists in the table or not. So even if this transaction is executed multiple times, it will not cause any side
 * effects.&lt;/p&gt;
 *
 * &lt;p&gt;Without this check, the transaction might duplicate documents in the table if it is retried. A retry may happen when the
 * transaction commits successfully on QLDB server side, but the driver/client timeouts waiting for a response.&lt;/p&gt;
 *
 * For example, the following code shows a lambda that is retryable:
 * &lt;pre&gt;{@code
 * driver.execute(txn -&gt; {
 *     Result result = txn.execute(&quot;SELECT firstName, age, lastName FROM People WHERE firstName = 'Bob'&quot;);
 *     boolean recordExists = result.iterator().hasNext();
 *     if (recordExists) {
 *        txn.execute(&quot;UPDATE People SET age = 32 WHERE firstName = 'Bob'&quot;);
 *     } else {
 *        txn.execute(&quot;INSERT INTO People {'firstName': 'Bob', 'lastName': 'Doe', 'age':32}&quot;);
 *     }
 * });
 * }&lt;/pre&gt;
 *
 * &lt;h3&gt;Instantiating the driver&lt;/h3&gt;
 * The driver can be instantiated using the {@link QldbDriverBuilder}. Example:
 *
 * &lt;pre&gt;{@code
 *     QldbSessionClientBuilder sessionClientBuilder = QldbSessionClient.builder();
 *
 *     QldbDriverBuilder builder = QldbDriver
 *          .builder()
 *          .ledger(ledger);
 *          .maxConcurrentTransactions(poolLimit)
 *          .transactionRetryPolicy(RetryPolicy.maxRetries(3));
 *          .sessionClientBuilder(sessionClientBuilder)
 *          .build();
 * }&lt;/pre&gt;
 *
 *
 *
 */
public interface QldbDriver extends AutoCloseable {
    /**
     * Execute the Executor lambda against QLDB within a transaction where no result is expected.
     *
     * @param executor
     *              A lambda with no return value representing the block of code to be executed within the transaction.
     *              This cannot have any side effects as it may be invoked multiple times.
     *
     * @throws software.amazon.awssdk.core.exception.SdkException if there is an error executing against QLDB.
     */
    void execute(ExecutorNoReturn executor);

    /**
     * &lt;p&gt;Execute the Executor lambda against QLDB within a transaction where no result is expected.&lt;/p&gt;
     *
     * This method accepts a RetryPolicy that overrides the RetryPolicy set when creating the driver. Use it
     * to customize the backoff delay used when retrying transactions.
     *
     * @param executor
     *              A lambda with no return value representing the block of code to be executed within the transaction.
     *              This cannot have any side effects as it may be invoked multiple times.
     *
     * @param retryPolicy
     *              A {@link RetryPolicy} that overrides the RetryPolicy set when creating the driver. The given retry policy
     *              will be used when retrying the transaction.
     * @throws TransactionAbortedException if the Executor lambda calls {@link TransactionExecutor#abort()}.
     * @throws software.amazon.awssdk.core.exception.SdkException if there is an error executing against QLDB.
     */
    void execute(ExecutorNoReturn executor, RetryPolicy retryPolicy);

    /**
     * Execute the Executor lambda against QLDB and retrieve the result within a transaction.
     *
     * @param executor
     *              A lambda representing the block of code to be executed within the transaction. This cannot have any
     *              side effects as it may be invoked multiple times, and the result cannot be trusted until the
     *              transaction is committed.
     * @param &lt;T&gt;
     *         The type of value that will be returned.
     *
     * @return The return value of executing the executor. Note that if you directly return a {@link Result}, this will
     *         be automatically buffered in memory before the implicit commit to allow reading, as the commit will close
     *         any open results. Any other {@link Result} instances created within the executor block will be
     *         invalidated, including if the return value is an object which nests said {@link Result} instances within
     *         it.
     * @throws TransactionAbortedException if the Executor lambda calls {@link TransactionExecutor#abort()}.
     * @throws software.amazon.awssdk.core.exception.SdkException if there is an error executing against QLDB.
     */
    &lt;T&gt; T execute(Executor&lt;T&gt; executor);

    /**
     * Execute the Executor lambda against QLDB and retrieve the result within a transaction.
     *
     * This method accepts a RetryPolicy that overrides the RetryPolicy set when creating the driver. Use it
     * to customize the backoff delay used when retrying transactions.
     *
     * @param executor
     *              A lambda representing the block of code to be executed within the transaction. This cannot have any
     *              side effects as it may be invoked multiple times, and the result cannot be trusted until the
     *              transaction is committed.
     * @param retryPolicy
     *              A {@link RetryPolicy} that overrides the RetryPolicy set when creating the driver. The given retry policy
     *              will be used when retrying the transaction.
     *
     * @param &lt;T&gt;
     *         The type of value that will be returned.
     *
     * @return The return value of executing the executor. Note that if you directly return a {@link Result}, this will
     *         be automatically buffered in memory before the implicit commit to allow reading, as the commit will close
     *         any open results. Any other {@link Result} instances created within the executor block will be
     *         invalidated, including if the return value is an object which nests said {@link Result} instances within
     *         it.
     * @throws TransactionAbortedException if the Executor lambda calls {@link TransactionExecutor#abort()}.
     * @throws software.amazon.awssdk.core.exception.SdkException if there is an error executing against QLDB.
     */
    &lt;T&gt; T execute(Executor&lt;T&gt; executor, RetryPolicy retryPolicy);

    /**
     * Retrieve the table names that are available within the ledger.
     *
     * @return The Iterable over the table names in the ledger.
     * @throws IllegalStateException if this QldbSession has been closed already, or if the transaction's commit
     *                               digest does not match the response from QLDB.
     * @throws software.amazon.awssdk.core.exception.SdkException if there is an error communicating with QLDB.
     */
    Iterable&lt;String&gt; getTableNames();


    static QldbDriverBuilder builder() {
<span class="fc" id="L156">        return new QldbDriverImplBuilder();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>