<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultQldbTransactionBackoffStrategy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">software.amazon.qldb:amazon-qldb-driver-java</a> &gt; <a href="index.source.html" class="el_package">software.amazon.qldb</a> &gt; <span class="el_source">DefaultQldbTransactionBackoffStrategy.java</span></div><h1>DefaultQldbTransactionBackoffStrategy.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;). You may not use this file except in compliance with
 * the License. A copy of the License is located at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the &quot;license&quot; file accompanying this file. This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions
 * and limitations under the License.
 */

package software.amazon.qldb;

import java.time.Duration;
import java.util.Random;
import software.amazon.awssdk.utils.Validate;

/**
 * BackoffStrategy that calculates the time to delay the execution of the next transaction.
 *
 * &lt;p&gt;
 * The backoff strategy uses a min delay of 10ms and max delay of 5000ms using an
 * equal jitter strategy.
 * &lt;/p&gt;
 *
 * &lt;pre&gt;{@code
 * exponential delay  = min( base delay * (2 ^ retry attempts), max delay)
 * jitter = random()
 * sleep time = exponential delay / 2 + jitter * exponential delay / 2
 *
 * }&lt;/pre&gt;
 */
public class DefaultQldbTransactionBackoffStrategy implements BackoffStrategy {
<span class="fc" id="L36">    static final Duration BASE_DELAY_CEILING = Duration.ofMillis(10);</span>
<span class="fc" id="L37">    private static final Duration MAX_BACKOFF_CEILING = Duration.ofMillis(5000);</span>
    /**
     * Max permitted retry times. To prevent exponentialDelay from overflow, there must be 2 ^ retriesAttempted
     * &lt;= 2 ^ 31 - 1, which means retriesAttempted &lt;= 30, so that is the ceil for retriesAttempted.
     */
<span class="fc" id="L42">    private static final int RETRIES_ATTEMPTED_CEILING = (int) Math.floor(Math.log(Integer.MAX_VALUE) / Math.log(2));</span>

    private final Duration baseDelay ;
    private final Duration maxBackoffTime;
    private final Random random;


    DefaultQldbTransactionBackoffStrategy() {
<span class="fc" id="L50">        this(BASE_DELAY_CEILING, MAX_BACKOFF_CEILING, new Random());</span>
<span class="fc" id="L51">    }</span>

<span class="fc" id="L53">    DefaultQldbTransactionBackoffStrategy(final Duration baseDelay, final Duration maxBackoffTime, final Random random) {</span>
<span class="fc" id="L54">        this.baseDelay = Validate.isNotNegative(baseDelay, &quot;baseDelay&quot;);</span>
<span class="fc" id="L55">        this.maxBackoffTime = Validate.isNotNegative(maxBackoffTime, &quot;maxBackoffTime&quot;);</span>

<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (baseDelay.compareTo(maxBackoffTime) &gt; 0) {</span>
<span class="fc" id="L58">            throw new IllegalArgumentException(String.format(&quot;%s cannot be greater than %s&quot;, &quot;baseDelay&quot;, &quot;maxBackoffTime&quot;));</span>
        }

<span class="fc" id="L61">        this.random = random;</span>
<span class="fc" id="L62">    }</span>

    /**
     * Constructor to create a Backoff Strategy but with custom baseDelay and cap backoff time.
     * @param baseDelay The minimum amount of time to delay a retry.
     * @param maxBackoffTime The maximum time to delay a retry.
     */
    public DefaultQldbTransactionBackoffStrategy(final Duration baseDelay, final Duration maxBackoffTime) {
<span class="fc" id="L70">        this(baseDelay, maxBackoffTime, new Random());</span>
<span class="fc" id="L71">    }</span>

    /**
     * &lt;p&gt;Compute the delay before the next retry request.&lt;/p&gt;
     *
     * &lt;p&gt;This strategy is only consulted when there will be a next retry.&lt;/p&gt;
     *
     * @param retryPolicyContext Number of retries that will be attempted.
     * @return Amount of time in milliseconds to wait before the next attempt. Must be non-negative (can be zero).
     */
    @Override
    public Duration calculateDelay(RetryPolicyContext retryPolicyContext) {
<span class="fc" id="L83">        int cappedRetries = Math.min(retryPolicyContext.retriesAttempted(), RETRIES_ATTEMPTED_CEILING);</span>
<span class="fc" id="L84">        int delay = (int) Math.min(baseDelay.multipliedBy(1L &lt;&lt; cappedRetries).toMillis(), maxBackoffTime.toMillis());</span>
<span class="fc" id="L85">        return Duration.ofMillis((delay / 2) + random.nextInt((delay / 2) + 1));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>